<html>

<head>
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"
    integrity="sha384-KAZ4DtjNhLChOB/hxXuKqhMLYvx3b5MlT55xPEiNmREKRzeEm+RVPlTnAn0ajQNs"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <main>
    <h1 style="text-align: center;">Adult'R - Ton appli de rencontre incognito sans historique</h1>
    <div id="login" class="login">
      <label for="userName">Entrez votre nom:</label>
      <input type="text" id="userName" />
      <button id="logbtn">Confirmer</button>
    </div>
    <div id="box" style="display: none;" class="messageBox">

    </div>
    <div id="messageSend" style="display: none;">
      <input type="text" id="message" />
      <button id='btn'>Envoyer</button>
    </div>
  </main>
</body>

<script>
  let userName = '';
  const socket = io('https://chat-app-tl.herokuapp.com/');
  socket.on('connect', function () {
    console.log('Connected');

    socket.emit('events', { test: 'test' });
    socket.emit('identity', 0, response =>
      console.log('Identity:', response),
    );
  });

  socket.on('disconnect', function () {
    document.getElementById('box').innerHTML += `<p>${userName} a quittÃ© le chat`;
  })

  const handleMessageEmit = () => {
    socket.emit('message', { data: userName + ": " + document.getElementById('message').value })
    document.getElementById('message').value = '';
  }

  const handleInscription = () => {
    userName = document.getElementById('userName').value;
    document.getElementById('login').style.display = 'none';
    document.getElementById('box').style.display = 'unset';
    document.getElementById('messageSend').style.display = 'unset';
    socket.emit("message", { data: `Alerte: ${userName} rejoint le chat` })
  }

  const othermess = "padding: 10px 15px; border-radius: 10px; background-color: rgba(230,230,230,0.9); width: fit-content; margin-left: auto; margin-bottom: 20px";
  const mymess = "padding: 5px 15px; border-radius: 10px; background-color: rgba(230,230,230,0.9); width: fit-content; margin-bottom: 20px";
  const msg = [];
  socket.on('message', ({ data }) => {
    msg.push(data);
    let str = '';
    for (const elt of msg) {
      if (elt.split(':')[0] === "Alerte") {
        str += `<p style="color:red;">${elt}</p>`;
      } else if (elt.split(':')[0] !== "Alerte" && elt.split(':')[0] !== userName) {
        str += `<div style="${othermess}"> <p style="text-align: end; margin:0;"> <span style="font-weight: 800">${elt.split(':')[0]}:</span>${elt.split(':')[1]}</p> </div>`;
      } else {
        str += `<div style="${mymess}"><p style="margin: 0;"> <span style="font-weight: 800">${elt.split(':')[0]}:</span>${elt.split(':')[1]}</p></div>`;
      }
    }
    document.getElementById('box').innerHTML = str;
  })

  document.getElementById('userName').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') handleInscription();
  })

  document.getElementById('message').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') handleMessageEmit();
  })

  document.getElementById('logbtn').addEventListener('click', handleInscription)
  document.getElementById('btn').addEventListener('click', handleMessageEmit)

</script>

</html>